<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>材料取り割付 - iPhone Dark Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --ios-bg: #000000;
            --ios-secondary-bg: #1c1c1e;
            --ios-tertiary-bg: #2c2c2e;
            --ios-quaternary-bg: #3a3a3c;
            --ios-blue: #0a84ff;
            --ios-green: #30d158;
            --ios-orange: #ff9f0a;
            --ios-orange-deep: #ff8000;
            --ios-text: #ffffff;
            --ios-text-secondary: #8e8e93;
            --ios-separator: #545458; 
            --ios-silver: #c0c0c0;
        }

        body {
            background-color: var(--ios-bg);
            color: var(--ios-text);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Icons", "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            line-height: 1.5;
            touch-action: pan-y;
        }

        .tab-switcher {
            background: linear-gradient(180deg, #161618 0%, #2c2c2e 100%);
            padding: 3px;
            border-radius: 12px;
            display: flex;
            margin-bottom: 20px;
            border: 1px solid var(--ios-separator);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5), 0 1px 0 rgba(255,255,255,0.05);
        }
        .tab-btn {
            flex: 1;
            padding: 6px 0;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            border-radius: 9px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--ios-text-secondary);
            border: 1px solid transparent;
        }
        .tab-btn.active {
            background: linear-gradient(180deg, #636366 0%, #48484a 100%);
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.15);
            border: 2px solid var(--ios-orange) !important;
            transform: translateY(-1px);
        }

        .btn-3d-gray {
            background: linear-gradient(180deg, #8e8e93 0%, #636366 100%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            border: 1px solid #48484a;
            transition: all 0.1s ease;
        }
        .btn-3d-gray:active { transform: translateY(1px); background: linear-gradient(180deg, #636366 0%, #8e8e93 100%); }

        .btn-3d-red {
            background: linear-gradient(180deg, #ff453a 0%, #d70015 100%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            border: 1px solid #c9342b;
            transition: all 0.1s ease; color: white;
        }
        .btn-3d-red:active { transform: translateY(1px); background: linear-gradient(180deg, #d70015 0%, #ff453a 100%); }

        .btn-3d-orange {
            background: linear-gradient(180deg, #ff9500 0%, #e67600 100%);
            box-shadow: 0 4px 12px rgba(230, 118, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.2);
            border: 1px solid #b35c00;
            transition: all 0.1s ease; color: white;
        }
        .btn-3d-orange:active { transform: translateY(2px); background: linear-gradient(180deg, #e67600 0%, #ff9500 100%); box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 4px rgba(0,0,0,0.3); }

        .input-field {
            background-color: var(--ios-tertiary-bg);
            border: 1px solid var(--ios-separator) !important;
            color: var(--ios-text);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%; 
            padding: 0.4rem 1rem; 
            font-size: 1.25rem; 
            text-align: center; 
            height: 2.8rem; 
            border-radius: 12px;
        }
        .input-field:focus {
            border-width: 2px !important;
            border-color: var(--ios-orange) !important;
            background-color: var(--ios-quaternary-bg);
            outline: none;
            transform: scale(1.01);
        }
        
        #pitch:focus { border-color: var(--ios-blue) !important; }
        #count:focus { border-color: var(--ios-green) !important; }

        .text-pitch { color: var(--ios-blue) !important; }
        .text-count { color: var(--ios-green) !important; }
        .text-auto { color: var(--ios-text-secondary) !important; }

        .input-field::placeholder { font-size: 15px; }

        #memoDim, #pitch, #count { font-size: 1.5rem; }
        #memoDim { padding-right: 2.5rem; }

        #totalLength { 
            font-size: 1.5rem; 
            padding-right: 4.5rem;
        }
        #inputNo { 
            font-size: 1.15rem; 
        }

        .input-unit-display { position: absolute; right: 38px; font-size: 14px; color: var(--ios-text-secondary); pointer-events: none; }

        .clear-input-btn { position: absolute; right: 2px; color: var(--ios-text-secondary); padding: 8px; opacity: 0.6; display: none; }
        .input-field:not(:placeholder-shown) + .clear-input-btn { display: block; }

        .mini-clear-btn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(180deg, #8e8e93 0%, #636366 100%);
            color: white;
            border-radius: 8px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            border: 1px solid #48484a;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            opacity: 0.9;
        }
        .mini-clear-btn:active {
            transform: translateY(-50%) scale(0.95);
            background: linear-gradient(180deg, #636366 0%, #8e8e93 100%);
        }

        .result-card { background: var(--ios-secondary-bg); border-radius: 14px; border-left: 6px solid var(--ios-blue); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); }
        .result-card-green { border-left-color: var(--ios-green); }

        .ios-label { font-size: 14px; font-weight: 600; letter-spacing: 0.05em; margin-bottom: 2px; }
        .sticky-header th { border-bottom: 2px solid var(--ios-separator); }
        .sticky-footer td { border-top: 2px solid var(--ios-separator); background-color: var(--ios-secondary-bg); }
        #historyTableBody tr { background-color: var(--ios-tertiary-bg); }
        #historyTableBody tr:active { background-color: var(--ios-quaternary-bg); }

        #saveToast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            background: rgba(44, 44, 46, 0.9); backdrop-filter: blur(20px); color: white; padding: 20px 30px;
            border-radius: 20px; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 12px; opacity: 0; visibility: hidden; transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); pointer-events: none;
        }
        #saveToast.show { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }

        #confirmModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px);
            z-index: 999; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden;
            transition: all 0.3s ease; pointer-events: none;
        }
        #confirmModal.show { opacity: 1; visibility: visible; pointer-events: auto; }
        .modal-content { background: #2c2c2e; border-radius: 14px; width: 100%; max-width: 270px; text-align: center; overflow: hidden; transform: scale(1.1); }
        #confirmModal.show .modal-content { transform: scale(1); }
        .modal-body { padding: 20px 16px; }
        .modal-footer { display: flex; border-top: 0.5px solid var(--ios-separator); }
        .modal-btn { flex: 1; padding: 12px; font-size: 17px; border: none; background: transparent; cursor: pointer; }
        .modal-btn-cancel { color: var(--ios-blue); font-weight: 400; border-right: 0.5px solid var(--ios-separator); }
        .modal-btn-delete { color: #ff453a; font-weight: 600; }

        .screen { display: none; }
        .screen.active { display: block; }

        .star-mark { color: var(--ios-orange); margin-left: 4px; display: none; }
        .star-mark.active { display: inline; }

        /* 集計用インライン編集スタイル */
        .editable-memo {
            background: transparent;
            border: none;
            color: white;
            font-weight: bold;
            width: 100%;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .editable-memo:focus {
            background: var(--ios-quaternary-bg);
            outline: 1px solid var(--ios-orange);
        }

        /* カスタムドロップダウンメニューのスタイル */
        .memo-dropdown-item {
            padding: 12px 16px;
            font-size: 15px;
            color: var(--ios-text);
            border-bottom: 1px solid var(--ios-separator);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .memo-dropdown-item:last-child {
            border-bottom: none;
        }
        .memo-dropdown-item:active {
            background-color: var(--ios-quaternary-bg);
        }
        /* スクロールバー非表示（Webkit用） */
        #memoDropdownList::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="p-4 pb-8 text-[14px]">
    <div id="swipe-container" class="max-w-md mx-auto min-h-screen">
        <header class="flex items-baseline justify-between pt-1 pb-2 px-1">
            <h1 class="text-[21px] font-bold tracking-tight">材料取り割付</h1>
            <div class="text-[14px] text-gray-400 uppercase tracking-[0.2em] font-medium">KYOWA ROOF</div>
        </header>
        
        <div class="tab-switcher mb-3">
            <button onclick="switchTab('calc')" id="tab-calc" class="tab-btn active">計算</button>
            <button onclick="switchTab('history')" id="tab-history" class="tab-btn">履歴</button>
        </div>

        <!-- 計算画面 -->
        <div id="screen-calc" class="screen active">
            <div class="bg-[#1c1c1e] p-3 rounded-[20px] mb-4 space-y-1.5">
                
                <!-- 寸法 (L) -->
                <div>
                    <label class="block ios-label text-[#ff9f0a] mb-0.5">寸法 (L)</label>
                    <div class="relative flex items-center">
                        <input type="text" id="memoDim" placeholder="材料の長さ" inputmode="decimal" class="input-field text-[#ff9f0a] font-medium">
                        <button class="clear-input-btn" onclick="clearSingleField('memoDim')">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm3.59 12.17L14.17 15.59 12 13.41l-2.17 2.18-1.42-1.42L10.59 12 8.41 9.83l1.42-1.42L12 10.59l2.17-2.18 1.42 1.42L13.41 12l2.18 2.17z"/></svg>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="block ios-label text-[#0a84ff]">働き (＠)</label>
                        <div class="relative flex items-center">
                            <input type="text" id="pitch" placeholder="ピッチ" inputmode="decimal" class="input-field font-medium">
                        </div>
                    </div>
                    <div>
                        <label class="block ios-label text-[#30d158]">数量 (N)</label>
                        <div class="relative flex items-center">
                            <input type="text" id="count" placeholder="数量" inputmode="numeric" class="input-field font-medium">
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex gap-2 mb-0.5">
                        <label class="ios-label text-gray-400 mb-0 w-full text-[14px]">全幅 (W)</label>
                    </div>
                    <div class="relative flex items-center mb-1.5">
                        <input type="text" id="totalLength" placeholder="施工面の張り幅" inputmode="decimal" class="input-field font-bold">
                        <button onclick="clearSingleField('totalLength')" class="mini-clear-btn">C</button>
                    </div>
                    <div class="flex gap-2">
                        <div class="relative flex-grow flex items-center">
                            <input type="text" id="addLength" placeholder="＋加算" inputmode="decimal" class="input-field">
                        </div>
                        <button onclick="executeAddition()" class="w-12 h-[2.8rem] btn-3d-orange text-white rounded-xl flex items-center justify-center text-[22px] font-bold shrink-0">＋</button>
                        <button onclick="clearAllFields()" class="w-16 h-[2.8rem] btn-3d-gray text-white rounded-xl flex items-center justify-center text-[14px] leading-[1.1] font-bold shrink-0 text-center px-1">全クリア</button>
                    </div>
                </div>
            </div>

            <div class="mb-6 bg-[#1c1c1e] p-3 rounded-[20px] space-y-3">
                <!-- 備考と保存ボタンを同じ背景枠に配置 -->
                <div class="relative z-20">
                    <div class="relative flex items-center">
                        <span class="absolute left-4 text-[14px] font-bold text-gray-400 pointer-events-none z-10">備考</span>
                        <!-- autocomplete="off" を追加してブラウザの予測を無効化。背景を黒にするクラスを追加 -->
                        <input type="text" id="inputNo" placeholder="" class="input-field relative z-0 !bg-black focus:!bg-[#3a3a3c]" style="text-align: center; padding-left: 3.5rem; padding-right: 2.5rem;" autocomplete="off">
                        
                        <!-- プルダウン開閉用ボタン -->
                        <button id="memoDropdownBtn" class="absolute right-2 p-2 text-[#ff9f0a] focus:outline-none z-10" tabindex="-1">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        </button>

                        <!-- ドロップダウンリスト本体 -->
                        <div id="memoDropdown" class="absolute top-[110%] left-0 w-full bg-[#2c2c2e] border border-[#545458] rounded-xl shadow-[0_10px_30px_rgba(0,0,0,0.8)] z-50 hidden overflow-hidden">
                            <ul id="memoDropdownList" class="max-h-48 overflow-y-scroll">
                                <!-- JSで動的に生成 -->
                            </ul>
                        </div>
                    </div>
                </div>

                <button id="btnSave" onclick="manualSaveToHistory()" class="w-full py-2.5 btn-3d-orange rounded-xl active:opacity-60 transition-all flex items-center justify-center gap-2 text-[16px] font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    履歴に保存
                </button>
            </div>

            <div id="results" class="space-y-4">
                <div class="result-card py-2 px-4">
                    <div class="text-[14px] text-[#8e8e93] mb-1 uppercase tracking-[0.15em] font-bold">
                        働き基準 結果<span id="starPitch" class="star-mark">★</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 border-t border-[#545458] pt-2">
                        <div>
                            <div class="text-[14px] text-[#0a84ff] mb-0.5">必要数量</div>
                            <div class="flex items-baseline gap-1 text-[#0a84ff]">
                                <span id="resQuantity" class="text-2xl font-semibold">-</span>
                                <span id="unitQuantity" class="text-[14px] hidden">枚</span>
                            </div>
                        </div>
                        <div>
                            <div class="text-[14px] text-gray-400 mb-0.5">残材余り</div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-baseline gap-1">
                                    <span id="resQtyRemainder" class="text-2xl font-semibold">-</span>
                                    <span id="unitQtyRem" class="text-[14px] text-gray-300 hidden">㎜</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="result-card result-card-green py-2 px-4">
                    <div class="text-[14px] text-[#8e8e93] mb-1 uppercase tracking-[0.15em] font-bold">
                        数量基準 結果<span id="starCount" class="star-mark">★</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 border-t border-[#545458] pt-2">
                        <div>
                            <div class="text-[14px] text-[#30d158] mb-0.5">必要働き</div>
                            <div class="flex items-baseline gap-1 text-[#30d158]">
                                <span id="resWidth" class="text-2xl font-semibold">-</span>
                                <span id="unitWidth" class="text-[14px] hidden">㎜</span>
                            </div>
                        </div>
                        <div>
                            <div class="text-[14px] text-gray-400 mb-0.5">残材余り</div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-baseline gap-1">
                                    <span id="resWidthRemainder" class="text-2xl font-semibold">-</span>
                                    <span id="unitWidthRem" class="text-[14px] text-gray-300 hidden">㎜</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 履歴画面 -->
        <div id="screen-history" class="screen">
            <!-- 備考別合計の枠 -->
            <div id="memoSummaryBox" class="bg-[#1c1c1e] rounded-[20px] shadow-2xl overflow-hidden border border-[#545458] mb-4 hidden">
                <div class="bg-[#2c2c2e] py-1.5 px-4 border-b border-[#545458]">
                    <h2 class="text-[14px] font-bold text-gray-300 uppercase tracking-widest">備考別 合計枚数</h2>
                </div>
                <div id="memoSummaryList" class="p-1.5 space-y-1.5">
                    <!-- JavaScriptで生成 -->
                </div>
            </div>

            <!-- 計算履歴 -->
            <div class="bg-[#1c1c1e] rounded-[20px] shadow-2xl overflow-hidden border border-[#545458] mb-4">
                <div class="bg-[#2c2c2e] py-1.5 px-4 flex justify-between items-center border-b border-[#545458]">
                    <h2 class="text-[14px] font-bold text-gray-300 uppercase tracking-widest">計算履歴</h2>
                    <button onclick="showConfirmModal()" class="btn-3d-red text-[12px] px-2.5 py-0.5 rounded-full font-bold">全削除</button>
                </div>
                <div class="table-container bg-[#1c1c1e]">
                    <table class="w-full text-center border-collapse table-fixed">
                        <thead class="sticky-header">
                            <tr class="text-[14px] font-bold">
                                <th class="py-1 px-1 border-r border-[#545458] w-[45%] text-[#0a84ff]">働き基準結果</th>
                                <th class="py-1 px-1 border-r border-[#545458] w-[45%] text-[#30d158]">数量基準結果</th>
                                <th class="w-[10%]"></th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="text-gray-200"></tbody>
                        <tfoot id="historyTableFoot" class="sticky-footer">
                            <tr>
                                <td colspan="2" class="py-1 px-4">
                                    <div class="flex justify-around items-center">
                                        <div class="text-center">
                                            <div class="text-[14px] text-gray-400 uppercase font-bold">働き基準合計</div>
                                            <div id="totalQtySum" class="text-[16px] font-bold text-[#0a84ff]">-</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-[14px] text-gray-400 uppercase font-bold">数量基準合計</div>
                                            <div id="totalCountSum" class="text-[16px] font-bold text-[#30d158]">-</div>
                                        </div>
                                    </div>
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="saveToast">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#30d158" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        <div class="text-lg font-semibold">保存しました</div>
    </div>

    <div id="confirmModal">
        <div class="modal-content text-[15px]">
            <div class="modal-body">
                <div class="text-white font-semibold mb-1 text-lg">履歴を削除</div>
                <div class="text-gray-400 text-[14px]">すべての計算履歴を完全に消去しますか？</div>
            </div>
            <div class="modal-footer">
                <button onclick="hideConfirmModal()" class="modal-btn modal-btn-cancel">キャンセル</button>
                <button onclick="clearHistory()" class="modal-btn modal-btn-delete">削除する</button>
            </div>
        </div>
    </div>

    <script>
        const totalLengthInput = document.getElementById('totalLength');
        const addLengthInput = document.getElementById('addLength');
        const memoDimInput = document.getElementById('memoDim');
        const pitchInput = document.getElementById('pitch');
        const countInput = document.getElementById('count');
        const inputNo = document.getElementById('inputNo');

        const resQuantity = document.getElementById('resQuantity');
        const resQtyRemainder = document.getElementById('resQtyRemainder');
        const resWidth = document.getElementById('resWidth');
        const resWidthRemainder = document.getElementById('resWidthRemainder');
        
        const unitQuantity = document.getElementById('unitQuantity');
        const unitQtyRem = document.getElementById('unitQtyRem');
        const unitWidth = document.getElementById('unitWidth');
        const unitWidthRem = document.getElementById('unitWidthRem');

        const starPitch = document.getElementById('starPitch');
        const starCount = document.getElementById('starCount');

        const historyTableBody = document.getElementById('historyTableBody');
        const totalQtySum = document.getElementById('totalQtySum');
        const totalCountSum = document.getElementById('totalCountSum');
        const memoSummaryBox = document.getElementById('memoSummaryBox');
        const memoSummaryList = document.getElementById('memoSummaryList');
        const confirmModal = document.getElementById('confirmModal');
        const saveToast = document.getElementById('saveToast');

        // ドロップダウン用の要素
        const memoDropdown = document.getElementById('memoDropdown');
        const memoDropdownList = document.getElementById('memoDropdownList');
        const memoDropdownBtn = document.getElementById('memoDropdownBtn');

        let historyData = [];
        let currentTab = 'calc';
        let touchStartX = 0;
        let touchStartY = 0;
        let inputSource = null;

        window.onload = function() {
            const savedHistory = localStorage.getItem('waritsuke_history');
            if (savedHistory) { try { historyData = JSON.parse(savedHistory); updateHistoryTable(false); } catch(e) {} }
            const savedInputs = localStorage.getItem('waritsuke_inputs');
            if (savedInputs) {
                try {
                    const inputs = JSON.parse(savedInputs);
                    totalLengthInput.value = inputs.totalLength || "";
                    memoDimInput.value = inputs.memoDim || "";
                    pitchInput.value = inputs.pitch || "";
                    countInput.value = inputs.count || "";
                    inputNo.value = inputs.inputNo || "";
                    if (pitchInput.value !== "") inputSource = 'pitch';
                    else if (countInput.value !== "") inputSource = 'count';
                    [totalLengthInput, memoDimInput, pitchInput, countInput, inputNo].forEach(el => { 
                        if (el) { formatInputDisplay(el); }
                    });
                    calculate();
                } catch(e) {}
            }
            initSwipeGestures();
            updateMemoDropdown(); // 初回起動時にドロップダウンの中身を生成
        };

        function initSwipeGestures() {
            document.body.addEventListener('touchstart', (e) => { 
                touchStartX = e.changedTouches[0].screenX; touchStartY = e.changedTouches[0].screenY; 
            }, { passive: true });
            document.body.addEventListener('touchend', (e) => { 
                handleGesture(touchStartX, e.changedTouches[0].screenX, touchStartY, e.changedTouches[0].screenY); 
            }, { passive: true });
        }

        function handleGesture(startX, endX, startY, endY) {
            const diffX = startX - endX;
            const diffY = Math.abs(startY - endY);
            if (diffY > 60 || document.activeElement.tagName === 'INPUT') return;
            if (diffX > 80 && currentTab === 'calc') switchTab('history');
            else if (diffX < -80 && currentTab === 'history') switchTab('calc');
        }

        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('screen-' + tabName).classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
            if (tabName === 'history') updateHistoryTable(false);
            window.scrollTo(0, 0);
        }

        function saveInputs() {
            const inputs = { totalLength: totalLengthInput.value, memoDim: memoDimInput.value, pitch: pitchInput.value, count: countInput.value, inputNo: inputNo.value };
            localStorage.setItem('waritsuke_inputs', JSON.stringify(inputs));
        }

        function formatNumber(num) { return (num === null || isNaN(num) || num === undefined) ? "-" : Math.round(num).toLocaleString('ja-JP'); }
        
        function parseValue(val) { 
            if (!val) return NaN; 
            let str = val.toString().replace(/[０-９．－]/g, function(s) {
                return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
            return parseFloat(str.replace(/[^-0-9.]/g, '')); 
        }

        function formatInputDisplay(input) {
            if (input.id === 'inputNo' || input.id === 'addLength') return;
            let num = parseValue(input.value);
            if (isNaN(num)) { input.value = ""; return; }
            input.value = num.toLocaleString('ja-JP');
        }

        function calculate() {
            const L = parseValue(totalLengthInput.value); 
            const W = parseValue(pitchInput.value);
            const N = parseValue(countInput.value);
            resQuantity.innerText = "-"; resQtyRemainder.innerText = "-";
            resWidth.innerText = "-"; resWidthRemainder.innerText = "-";
            [unitQuantity, unitQtyRem, unitWidth, unitWidthRem].forEach(u => u.classList.add('hidden'));
            
            if (isNaN(L) || (isNaN(W) && isNaN(N))) { resetCalculationUI(); return; }
            
            if (inputSource === 'pitch') {
                pitchInput.classList.remove('text-auto', 'text-count'); pitchInput.classList.add('text-pitch');
                countInput.classList.remove('text-auto', 'text-count'); countInput.classList.add('text-pitch');
                starPitch.classList.add('active'); starCount.classList.remove('active');
                if (W > 0) {
                    const qty = Math.ceil(L / W); const remP = (qty * W) - L;
                    countInput.value = qty.toLocaleString('ja-JP');
                    resQuantity.innerText = formatNumber(qty); resQtyRemainder.innerText = formatNumber(remP);
                    unitQuantity.classList.remove('hidden'); unitQtyRem.classList.remove('hidden');
                    const widthForN = Math.ceil(L / qty); const remN = (widthForN * qty) - L;
                    resWidth.innerText = formatNumber(widthForN); resWidthRemainder.innerText = formatNumber(remN);
                    unitWidth.classList.remove('hidden'); unitWidthRem.classList.remove('hidden');
                }
            } else if (inputSource === 'count') {
                countInput.classList.remove('text-auto', 'text-pitch'); countInput.classList.add('text-count');
                pitchInput.classList.remove('text-auto', 'text-pitch'); pitchInput.classList.add('text-count');
                starCount.classList.add('active'); starPitch.classList.remove('active');
                if (N > 0) {
                    const width = Math.ceil(L / N); const remN = (width * N) - L;
                    pitchInput.value = width.toLocaleString('ja-JP');
                    resWidth.innerText = formatNumber(width); resWidthRemainder.innerText = formatNumber(remN);
                    unitWidth.classList.remove('hidden'); unitWidthRem.classList.remove('hidden');
                    const qtyForW = Math.ceil(L / width); const remP = (qtyForW * width) - L;
                    resQuantity.innerText = formatNumber(qtyForW); resQtyRemainder.innerText = formatNumber(remP);
                    unitQuantity.classList.remove('hidden'); unitQtyRem.classList.remove('hidden');
                }
            }
        }

        function resetCalculationUI() {
            pitchInput.classList.remove('text-pitch', 'text-count', 'text-auto');
            countInput.classList.remove('text-pitch', 'text-count', 'text-auto');
            starPitch.classList.remove('active'); starCount.classList.remove('active');
            resQuantity.innerText = "-"; resQtyRemainder.innerText = "-";
            resWidth.innerText = "-"; resWidthRemainder.innerText = "-";
            [unitQuantity, unitQtyRem, unitWidth, unitWidthRem].forEach(u => u.classList.add('hidden'));
        }

        // カスタムドロップダウンを生成する関数
        function updateMemoDropdown() {
            if (!memoDropdownList) return;
            
            const uniqueMemos = new Set();
            for (let i = historyData.length - 1; i >= 0; i--) {
                if (historyData[i].no && historyData[i].no.trim() !== "") {
                    uniqueMemos.add(historyData[i].no.trim());
                    if (uniqueMemos.size >= 5) break;
                }
            }

            memoDropdownList.innerHTML = '';
            
            if (uniqueMemos.size === 0) {
                const li = document.createElement('li');
                li.className = 'p-3 text-[14px] text-gray-500 text-center';
                li.innerText = '履歴がありません';
                memoDropdownList.appendChild(li);
                return;
            }

            uniqueMemos.forEach(memo => {
                const li = document.createElement('li');
                li.className = 'memo-dropdown-item text-center font-bold';
                li.innerText = memo;
                li.onclick = (e) => {
                    e.preventDefault(); 
                    inputNo.value = memo;
                    memoDropdown.classList.add('hidden');
                    calculate();
                    saveInputs();
                };
                memoDropdownList.appendChild(li);
            });
        }

        function updateHistoryTable(shouldSave = true) {
            historyTableBody.innerHTML = '';
            memoSummaryList.innerHTML = '';
            let sumQ = 0, sumN = 0;
            const separatorColor = "#545458"; 
            const summaryByMemo = {};

            historyData.slice().reverse().forEach((item, originalIdx) => {
                const idx = historyData.length - 1 - originalIdx;
                const tr = document.createElement('tr');
                tr.className = `border-t border-[${separatorColor}]`;
                const memoKey = item.no || "（備考なし）";
                if (!summaryByMemo[memoKey]) summaryByMemo[memoKey] = { pitch: 0, count: 0 };

                const memoHtml = item.memo ? `<div class="text-[14px] text-[#ff9f0a] font-medium truncate leading-tight">L:${item.memo}</div>` : '';
                const noBadge = item.no ? `<span class="inline-block bg-[#48484a] text-white text-[14px] px-1.5 py-0 rounded mr-1 font-bold leading-none">${item.no}</span>` : '';
                const widthLabel = `<div class="text-[14px] text-[#c0c0c0] font-bold leading-tight">W:${item.totalLength}</div>`;

                const td1 = document.createElement('td');
                td1.className = `py-0.5 px-1 border-r border-[${separatorColor}] cursor-pointer active:bg-gray-800`;
                td1.onclick = () => loadHistoryToInput(item, 'pitch');
                if (item.source === 'pitch') {
                    td1.innerHTML = `<div class="flex flex-col items-center justify-center leading-[1.1] py-0.5">${widthLabel}<div class="flex items-center justify-center my-[2px]">${noBadge}<span class="text-[16px] font-bold text-[#0a84ff] leading-none">${item.pitchResult}枚</span></div><div class="text-[14px] text-gray-400 leading-tight">@${item.pitchVal} 残:${item.pitchRem}</div>${memoHtml}</div>`;
                    sumQ += (item.pitchResultNum || 0);
                    summaryByMemo[memoKey].pitch += (item.pitchResultNum || 0);
                } else { td1.innerHTML = `<div class="text-gray-600 text-[14px]">-</div>`; }

                const td2 = document.createElement('td');
                td2.className = `py-0.5 px-1 border-r border-[${separatorColor}] cursor-pointer active:bg-gray-800`;
                td2.onclick = () => loadHistoryToInput(item, 'count');
                if (item.source === 'count') {
                    td2.innerHTML = `<div class="flex flex-col items-center justify-center leading-[1.1] py-0.5">${widthLabel}<div class="flex items-center justify-center my-[2px]">${noBadge}<span class="text-[16px] font-bold text-[#30d158] leading-none">${item.countVal}枚</span></div><div class="text-[14px] text-gray-400 leading-tight">@${item.countResult}㎜ 残:${item.countRem}</div>${memoHtml}</div>`;
                    sumN += (item.countValNum || 0);
                    summaryByMemo[memoKey].count += (item.countValNum || 0);
                } else { td2.innerHTML = `<div class="text-gray-600 text-[14px]">-</div>`; }
                
                const td3 = document.createElement('td');
                td3.className = "py-0";
                td3.innerHTML = `<button onclick="deleteHistoryRow(${idx})" class="p-1 text-red-500 active:text-red-600 w-full flex justify-center items-center"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>`;
                tr.append(td1, td2, td3);
                historyTableBody.appendChild(tr);
            });

            totalQtySum.innerText = sumQ > 0 ? formatNumber(sumQ) + "枚" : "-";
            totalCountSum.innerText = sumN > 0 ? formatNumber(sumN) + "枚" : "-";

            const memoKeys = Object.keys(summaryByMemo);
            if (memoKeys.length > 0) {
                memoSummaryBox.classList.remove('hidden');
                memoKeys.forEach(key => {
                    const data = summaryByMemo[key];
                    const div = document.createElement('div');
                    div.className = "bg-[#2c2c2e] p-2 px-3 rounded-xl flex flex-col gap-2 border border-[#545458]";
                    div.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center flex-grow mr-2 overflow-hidden">
                                <div class="text-[12px] text-gray-400 font-bold whitespace-nowrap mr-2">備考</div>
                                <input type="text" value="${key}" class="editable-memo text-[14px] w-full text-left" onchange="updateRemarkName('${key}', this.value)" placeholder="">
                            </div>
                            <button onclick="deleteByRemark('${key}')" class="p-1 text-red-500 active:opacity-50 shrink-0">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="bg-[#1c1c1e] rounded-lg p-2 border-l-[3px] border-[#0a84ff] flex items-baseline justify-between">
                                <div class="text-[12px] text-gray-400 font-bold">働き基準</div>
                                <div class="text-[16px] font-bold text-[#0a84ff] text-right">${data.pitch > 0 ? formatNumber(data.pitch) + "枚" : "-"}</div>
                            </div>
                            <div class="bg-[#1c1c1e] rounded-lg p-2 border-l-[3px] border-[#30d158] flex items-baseline justify-between">
                                <div class="text-[12px] text-gray-400 font-bold">数量基準</div>
                                <div class="text-[16px] font-bold text-[#30d158] text-right">${data.count > 0 ? formatNumber(data.count) + "枚" : "-"}</div>
                            </div>
                        </div>
                    `;
                    memoSummaryList.appendChild(div);
                });
            } else { memoSummaryBox.classList.add('hidden'); }
            
            // 履歴更新時にドロップダウンも更新
            updateMemoDropdown();

            if (shouldSave) localStorage.setItem('waritsuke_history', JSON.stringify(historyData));
        }

        function updateRemarkName(oldValue, newValue) {
            const finalOldValue = oldValue === "（備考なし）" ? "" : oldValue;
            const finalNewValue = newValue === "（備考なし）" ? "" : newValue;
            historyData.forEach(item => { if ((item.no || "") === finalOldValue) item.no = finalNewValue; });
            updateHistoryTable();
        }

        function deleteByRemark(remark) {
            const finalRemark = remark === "（備考なし）" ? "" : remark;
            historyData = historyData.filter(item => (item.no || "") !== finalRemark);
            updateHistoryTable();
        }

        function loadHistoryToInput(item, source) {
            totalLengthInput.value = item.totalLength;
            memoDimInput.value = item.memo || "";
            inputNo.value = item.no || "";
            if (source === 'pitch' && item.pitchVal) { pitchInput.value = item.pitchVal; inputSource = 'pitch'; }
            else if (source === 'count' && item.countVal) { countInput.value = item.countVal; inputSource = 'count'; }
            else {
                if (item.source === 'pitch') { pitchInput.value = item.pitchVal; inputSource = 'pitch'; }
                else { countInput.value = item.countVal; inputSource = 'count'; }
            }
            [totalLengthInput, memoDimInput, pitchInput, countInput, inputNo].forEach(el => { if(el) formatInputDisplay(el); });
            calculate(); saveInputs(); switchTab('calc');
        }

        function manualSaveToHistory() {
            const L = parseValue(totalLengthInput.value); 
            const W = parseValue(pitchInput.value);
            const N = parseValue(countInput.value);
            if (isNaN(L) || !inputSource) return;
            let historyEntry = { source: inputSource, totalLength: formatNumber(L), no: inputNo.value, memo: memoDimInput.value };
            if (inputSource === 'pitch' && !isNaN(W) && W > 0) {
                const qty = Math.ceil(L / W); const remP = (qty * W) - L;
                historyEntry.pitchVal = formatNumber(W); historyEntry.pitchResult = formatNumber(qty);
                historyEntry.pitchResultNum = qty; historyEntry.pitchRem = formatNumber(remP);
            } else if (inputSource === 'count' && !isNaN(N) && N > 0) {
                const width = Math.ceil(L / N); const remN = (width * N) - L;
                historyEntry.countVal = formatNumber(N); historyEntry.countValNum = N;
                historyEntry.countResult = formatNumber(width); historyEntry.countRem = formatNumber(remN);
            } else return;
            historyData.push(historyEntry); updateHistoryTable();
            saveToast.classList.add('show'); setTimeout(() => saveToast.classList.remove('show'), 1200);
        }

        function deleteHistoryRow(idx) { historyData.splice(idx, 1); updateHistoryTable(); }

        function clearSingleField(id) { 
            const el = document.getElementById(id); el.value = ''; 
            if (id === 'pitch' || id === 'count') { inputSource = null; pitchInput.value = ''; countInput.value = ''; }
            calculate(); saveInputs(); el.focus(); 
        }

        function clearAllFields() { 
            inputSource = null;
            [totalLengthInput, addLengthInput, memoDimInput, pitchInput, countInput, inputNo].forEach(el => { 
                if (el) { el.value = ''; }
            }); 
            calculate(); saveInputs(); 
        }

        function executeAddition() {
            const current = parseValue(totalLengthInput.value) || 0;
            const add = parseValue(addLengthInput.value);
            if (!isNaN(add)) {
                totalLengthInput.value = (current + add).toString();
                formatInputDisplay(totalLengthInput); addLengthInput.value = "";
                calculate(); saveInputs();
            }
            addLengthInput.focus();
        }

        function showConfirmModal() { if (historyData.length > 0) confirmModal.classList.add('show'); }
        function hideConfirmModal() { confirmModal.classList.remove('show'); }
        function clearHistory() { historyData = []; localStorage.removeItem('waritsuke_history'); updateHistoryTable(false); hideConfirmModal(); }

        // 各入力欄の共通イベント
        [totalLengthInput, addLengthInput, memoDimInput, pitchInput, countInput].forEach(el => {
            if (!el) return;
            el.addEventListener('focus', (e) => { 
                if (e.target.id !== 'addLength') { 
                    const val = parseValue(e.target.value); if (!isNaN(val)) e.target.value = val; 
                } 
                setTimeout(() => e.target.setSelectionRange(0, e.target.value.length), 10); 
            });
            el.addEventListener('input', (e) => { 
                if (e.target.id === 'pitch' || e.target.id === 'count') {
                    if (e.target.value === "") { pitchInput.value = ""; countInput.value = ""; inputSource = null; }
                    else { inputSource = e.target.id; }
                }
                if (e.target.id !== 'addLength') { calculate(); saveInputs(); }
            });
            el.addEventListener('blur', (e) => { 
                if (e.target.id !== 'addLength') { formatInputDisplay(e.target); saveInputs(); }
            });
            el.addEventListener('keydown', (e) => { 
                if (e.key === 'Enter') {
                    if (e.target.id === 'addLength') executeAddition(); 
                    else e.target.blur();
                }
            });
        });

        // inputNo (備考) 専用のイベント
        if (inputNo) {
            inputNo.addEventListener('focus', (e) => {
                setTimeout(() => e.target.setSelectionRange(0, e.target.value.length), 10);
            });
            
            inputNo.addEventListener('input', () => {
                calculate(); saveInputs();
            });

            inputNo.addEventListener('blur', (e) => {
                formatInputDisplay(e.target); saveInputs();
            });

            inputNo.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') e.target.blur();
            });
            
            inputNo.addEventListener('click', (e) => {
                e.stopPropagation(); // 外側タップ判定に影響させない
            });
        }

        // プルダウンボタンのイベント
        if (memoDropdownBtn) {
            memoDropdownBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation(); // 外側タップ判定に影響させない
                if (memoDropdown.classList.contains('hidden')) {
                    updateMemoDropdown();
                    memoDropdown.classList.remove('hidden');
                    inputNo.focus();
                } else {
                    memoDropdown.classList.add('hidden');
                }
            });
        }

        // ドロップダウン領域外をタップした時に閉じる処理
        document.addEventListener('click', (e) => {
            if (memoDropdown && !memoDropdown.classList.contains('hidden')) {
                if (!memoDropdown.contains(e.target)) {
                    memoDropdown.classList.add('hidden');
                }
            }
        });
        
        document.addEventListener('touchstart', (e) => {
            if (memoDropdown && !memoDropdown.classList.contains('hidden')) {
                if (e.target !== inputNo && e.target !== memoDropdownBtn && !memoDropdownBtn.contains(e.target) && !memoDropdown.contains(e.target)) {
                    memoDropdown.classList.add('hidden');
                }
            }
        }, { passive: true });

    </script>
</body>
</html>