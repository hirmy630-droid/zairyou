<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>材料割 計算 - iPhone Dark Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --ios-bg: #000000;
            --ios-secondary-bg: #1c1c1e;
            --ios-tertiary-bg: #2c2c2e;
            --ios-quaternary-bg: #3a3a3c;
            --ios-blue: #0a84ff;
            --ios-green: #30d158;
            --ios-orange: #ff9f0a;
            --ios-text: #ffffff;
            --ios-text-secondary: #8e8e93;
            --ios-separator: #545458; /* 一段階明るい罫線色 */
        }

        body {
            background-color: var(--ios-bg);
            color: var(--ios-text);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Icons", "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            line-height: 1.5;
            touch-action: pan-y; 
        }

        /* 立体的なタブ切り替えスタイル */
        .tab-switcher {
            background: linear-gradient(180deg, #161618 0%, #2c2c2e 100%);
            padding: 3px;
            border-radius: 12px;
            display: flex;
            margin-bottom: 20px;
            border: 1px solid var(--ios-separator);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5), 0 1px 0 rgba(255,255,255,0.05);
        }
        .tab-btn {
            flex: 1;
            padding: 8px 0;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            border-radius: 9px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--ios-text-secondary);
            border: 1px solid transparent;
        }
        .tab-btn.active {
            background: linear-gradient(180deg, #636366 0%, #48484a 100%);
            color: white;
            box-shadow: 
                0 4px 8px rgba(0,0,0,0.4), 
                inset 0 1px 0 rgba(255,255,255,0.15);
            border-color: #5a5a5e;
            transform: translateY(-1px);
        }

        /* 立体的なグレーボタン */
        .btn-3d-gray {
            background: linear-gradient(180deg, #8e8e93 0%, #636366 100%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            border: 1px solid #48484a;
            transition: all 0.1s ease;
        }
        .btn-3d-gray:active {
            transform: translateY(1px);
            background: linear-gradient(180deg, #636366 0%, #8e8e93 100%);
        }

        /* 立体的なレッドボタン（全削除用） */
        .btn-3d-red {
            background: linear-gradient(180deg, #ff453a 0%, #d70015 100%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            border: 1px solid #c9342b;
            transition: all 0.1s ease;
            color: white;
        }
        .btn-3d-red:active {
            transform: translateY(1px);
            background: linear-gradient(180deg, #d70015 0%, #ff453a 100%);
        }

        /* 立体的なオレンジボタン（保存用） */
        .btn-3d-orange {
            background: linear-gradient(180deg, #ffb340 0%, #ff9f0a 100%);
            box-shadow: 0 4px 12px rgba(255, 159, 10, 0.3), inset 0 1px 0 rgba(255,255,255,0.3);
            border: 1px solid #e68a00;
            transition: all 0.1s ease;
            color: white;
        }
        .btn-3d-orange:active {
            transform: translateY(2px);
            background: linear-gradient(180deg, #ff9f0a 0%, #ffb340 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 1px 4px rgba(0,0,0,0.3);
        }

        /* 入力フィールドのスタイル */
        .input-field {
            background-color: var(--ios-tertiary-bg);
            border: 1px solid var(--ios-separator);
            color: var(--ios-text);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            padding: 1rem;
            font-size: 1.25rem;
            text-align: center;
            height: 4rem; /* 全入力枠の縦幅を統一 */
        }

        /* プレースホルダー */
        .input-field::placeholder {
            font-size: 15px;
        }

        /* 寸法(L), 働き(＠), 数量(N) のフォントサイズを1.5remに統一 */
        #memoDim, #pitch, #count { 
            font-size: 1.5rem; 
        }

        #memoDim { 
            padding-right: 5.5rem; 
            text-align: center; 
        }
        
        /* 全幅(W)の固有スタイル */
        #totalLength {
            font-size: 1.65rem;
            border-color: var(--ios-orange);
            padding-right: 5.5rem;
            text-align: center;
        }
        
        /* 番号(No.)枠の固有スタイル */
        #inputNo {
            font-size: 1.15rem;
            border-color: var(--ios-orange);
            padding: 1rem !important;
        }

        .input-field:focus {
            background-color: var(--ios-quaternary-bg);
            border-color: var(--ios-blue);
            outline: none;
            transform: scale(1.01);
        }

        .input-unit-display {
            position: absolute;
            right: 36px;
            font-size: 0.85rem;
            color: var(--ios-text-secondary);
            pointer-events: none;
        }

        .clear-input-btn {
            position: absolute;
            right: 2px;
            color: var(--ios-text-secondary);
            padding: 8px;
            opacity: 0.6;
            display: none;
        }
        .input-field:not(:placeholder-shown) + .clear-input-btn { display: block; }

        .result-card {
            background: var(--ios-secondary-bg);
            border-radius: 14px;
            border-left: 6px solid var(--ios-blue);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        .result-card-green { border-left-color: var(--ios-green); }

        .ios-label {
            font-size: 15px;
            font-weight: 600;
            letter-spacing: 0.05em;
            margin-bottom: 0.4rem;
        }

        /* ヘッダー行の下に太線を追加 */
        .sticky-header th {
            border-bottom: 3px solid var(--ios-separator);
        }

        /* 合計行のスタイル（太線と背景） */
        .sticky-footer td {
            border-top: 3px solid var(--ios-separator);
            background-color: var(--ios-secondary-bg);
        }

        /* 履歴行のスタイル */
        #historyTableBody tr {
            background-color: var(--ios-tertiary-bg);
        }
        #historyTableBody tr:active {
            background-color: var(--ios-quaternary-bg);
        }

        #saveToast {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: rgba(44, 44, 46, 0.9);
            backdrop-filter: blur(20px);
            color: white; padding: 20px 30px;
            border-radius: 20px; z-index: 2000;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 12px; opacity: 0; visibility: hidden;
            transition: all 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            pointer-events: none;
        }
        #saveToast.show { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }

        #confirmModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px);
            z-index: 999; display: flex; align-items: center; justify-content: center;
            padding: 20px; opacity: 0; visibility: hidden;
            transition: all 0.3s ease; pointer-events: none;
        }
        #confirmModal.show { opacity: 1; visibility: visible; pointer-events: auto; }
        .modal-content {
            background: #2c2c2e; border-radius: 14px; width: 100%; max-width: 270px;
            text-align: center; overflow: hidden; transform: scale(1.1);
        }
        #confirmModal.show .modal-content { transform: scale(1); }
        .modal-body { padding: 20px 16px; }
        .modal-footer { display: flex; border-top: 0.5px solid var(--ios-separator); }
        .modal-btn { flex: 1; padding: 12px; font-size: 17px; border: none; background: transparent; cursor: pointer; }
        .modal-btn-cancel { color: var(--ios-blue); font-weight: 400; border-right: 0.5px solid var(--ios-separator); }
        .modal-btn-delete { color: #ff453a; font-weight: 600; }

        .screen { display: none; }
        .screen.active { display: block; }
    </style>
</head>
<body class="p-4 pb-8">
    <div id="swipe-container" class="max-w-md mx-auto min-h-screen">
        <header class="pt-2 pb-4 text-center">
            <h1 class="text-2xl font-semibold tracking-tight">材料割 計算</h1>
            <div class="text-[12px] text-gray-400 uppercase tracking-[0.2em] mt-1 mb-4">KYOWA ROOF PRO</div>
            
            <div class="tab-switcher">
                <button onclick="switchTab('calc')" id="tab-calc" class="tab-btn active">計算</button>
                <button onclick="switchTab('history')" id="tab-history" class="tab-btn">履歴</button>
            </div>
        </header>

        <!-- 計算画面 -->
        <div id="screen-calc" class="screen active">
            <div class="bg-[#1c1c1e] p-5 rounded-[20px] mb-4 space-y-5">
                <div>
                    <label class="block ios-label text-[#ff9f0a]">寸法 (L) <span class="text-[10px] opacity-70">※参考用</span></label>
                    <div class="flex gap-2">
                        <div class="relative flex-grow flex items-center">
                            <input type="text" id="memoDim" placeholder="L寸法" data-unit="㎜" inputmode="decimal" class="input-field p-4 rounded-xl text-[#ff9f0a] font-medium">
                            <span class="input-unit-display" id="unit-memoDim"></span>
                            <button class="clear-input-btn" onclick="clearSingleField('memoDim')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm3.59 12.17L14.17 15.59 12 13.41l-2.17 2.18-1.42-1.42L10.59 12 8.41 9.83l1.42-1.42L12 10.59l2.17-2.18 1.42 1.42L13.41 12l2.18 2.17z"/></svg>
                            </button>
                        </div>
                        <button onclick="clearAllFields()" class="w-16 btn-3d-gray text-white rounded-xl flex items-center justify-center text-[15px] font-bold shrink-0">
                            クリア
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block ios-label text-[#0a84ff]">働き (＠)</label>
                        <div class="relative flex items-center">
                            <input type="text" id="pitch" placeholder="ピッチ" inputmode="decimal" class="input-field p-4 rounded-xl text-[#0a84ff] font-medium">
                        </div>
                    </div>
                    <div>
                        <label class="block ios-label text-[#30d158]">数量 (N)</label>
                        <div class="relative flex items-center">
                            <input type="text" id="count" placeholder="数量" inputmode="numeric" class="input-field p-4 rounded-xl text-[#30d158] font-medium">
                        </div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-end mb-1">
                        <label class="ios-label text-gray-400 mb-0">全幅 (W) <span class="text-[10px]">※計算基準</span></label>
                        <label class="ios-label text-gray-400 mb-0 w-16 text-center">番号</label>
                    </div>
                    <div class="flex gap-2">
                        <div class="relative flex-grow flex items-center">
                            <input type="text" id="totalLength" placeholder="全幅を入力" data-unit="㎜" inputmode="decimal" class="input-field p-4 rounded-xl">
                            <span class="input-unit-display" id="unit-totalLength"></span>
                            <button class="clear-input-btn" onclick="clearSingleField('totalLength')">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm3.59 12.17L14.17 15.59 12 13.41l-2.17 2.18-1.42-1.42L10.59 12 8.41 9.83l1.42-1.42L12 10.59l2.17-2.18 1.42 1.42L13.41 12l2.18 2.17z"/></svg>
                            </button>
                        </div>
                        <div class="w-16 shrink-0">
                            <input type="text" id="inputNo" placeholder="No." inputmode="numeric" class="input-field p-4 rounded-xl">
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <button id="btnSave" onclick="manualSaveToHistory()" class="w-full py-4 btn-3d-orange rounded-xl active:opacity-60 transition-all flex items-center justify-center gap-2 text-[16px] font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                    履歴に保存
                </button>
            </div>

            <div id="results" class="space-y-4">
                <div class="result-card py-3 px-4">
                    <div class="text-[16px] text-[#0a84ff] mb-1 uppercase tracking-[0.15em] font-bold">働き計算結果 (W基準)</div>
                    <div class="grid grid-cols-2 gap-4 border-t border-[#545458] pt-2">
                        <div>
                            <div class="text-[15px] text-gray-400 mb-1">必要数量</div>
                            <div class="flex items-baseline gap-1">
                                <span id="resQuantity" class="text-2xl font-semibold">-</span>
                                <span id="unitQuantity" class="text-sm text-gray-300 hidden">枚</span>
                            </div>
                        </div>
                        <div>
                            <div class="text-[15px] text-gray-400 mb-1">残寸法</div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-baseline gap-1">
                                    <span id="resQtyRemainder" class="text-2xl font-semibold">-</span>
                                    <span id="unitQtyRem" class="text-sm text-gray-300 hidden">㎜</span>
                                </div>
                                <span id="resPitchLabel" class="text-[15px] text-gray-400 font-medium"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="result-card result-card-green py-3 px-4">
                    <div class="text-[16px] text-[#30d158] mb-1 uppercase tracking-[0.15em] font-bold">数量計算結果 (W基準)</div>
                    <div class="grid grid-cols-2 gap-4 border-t border-[#545458] pt-2">
                        <div>
                            <div class="flex items-baseline gap-1 mb-1">
                                <span class="text-[15px] text-gray-400">働き幅</span>
                                <span class="text-[13px] font-semibold text-gray-500 hidden" id="resWidthAt">(@)</span>
                            </div>
                            <div class="flex items-baseline gap-1">
                                <span id="resWidth" class="text-2xl font-semibold">-</span>
                                <span id="unitWidth" class="text-sm text-gray-300 hidden">㎜</span>
                            </div>
                        </div>
                        <div>
                            <div class="text-[15px] text-gray-400 mb-1">残寸法</div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-baseline gap-1">
                                    <span id="resWidthRemainder" class="text-2xl font-semibold">-</span>
                                    <span id="unitWidthRem" class="text-sm text-gray-300 hidden">㎜</span>
                                </div>
                                <span id="resCountLabel" class="text-[15px] text-gray-400 font-medium"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 履歴画面 -->
        <div id="screen-history" class="screen">
            <div class="bg-[#1c1c1e] rounded-[20px] shadow-2xl overflow-hidden border border-[#545458]">
                <div class="bg-[#2c2c2e] p-3 px-4 flex justify-between items-center border-b border-[#545458]">
                    <h2 class="text-[17px] font-bold text-gray-300 uppercase tracking-widest">計算履歴</h2>
                    <button onclick="showConfirmModal()" class="btn-3d-red text-[12px] px-3 py-1.5 rounded-full font-bold">全削除</button>
                </div>
                <div class="table-container bg-[#1c1c1e]">
                    <table class="w-full text-center border-collapse table-fixed">
                        <thead class="sticky-header shadow-md">
                            <tr class="text-[16px] font-bold">
                                <th class="py-3 px-2 border-r border-[#545458] w-[45%] text-[#0a84ff]">働き計算</th>
                                <th class="py-3 px-2 border-r border-[#545458] w-[45%] text-[#30d158]">数量計算</th>
                                <th class="w-[10%]"></th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="text-gray-200">
                        </tbody>
                        <tfoot id="historyTableFoot" class="sticky-footer">
                            <tr>
                                <td class="py-3 border-r border-[#545458]">
                                    <div class="text-[16px] text-gray-400 leading-none mb-1 uppercase font-bold">合計</div>
                                    <div id="totalQtySum" class="text-[21px] font-bold text-[#0a84ff]">-</div>
                                    <div id="totalQtyRemSum" class="text-[17px] text-gray-400">-</div>
                                </td>
                                <td class="py-3 border-r border-[#545458]">
                                    <div class="text-[16px] text-gray-400 leading-none mb-1 uppercase font-bold">合計(N)</div>
                                    <div id="totalCountSum" class="text-[21px] font-bold text-[#30d158]">-</div>
                                    <div id="totalWidthRemSum" class="text-[17px] text-gray-400">-</div>
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 共通パーツ -->
    <div id="saveToast">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#30d158" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
        <div class="text-lg font-semibold">保存しました</div>
    </div>

    <div id="confirmModal">
        <div class="modal-content">
            <div class="modal-body">
                <div class="text-white font-semibold mb-1 text-lg">履歴を削除</div>
                <div class="text-gray-400 text-sm">すべての計算履歴を完全に消去しますか？</div>
            </div>
            <div class="modal-footer">
                <button onclick="hideConfirmModal()" class="modal-btn modal-btn-cancel">キャンセル</button>
                <button onclick="clearHistory()" class="modal-btn modal-btn-delete">削除する</button>
            </div>
        </div>
    </div>

    <script>
        const totalLengthInput = document.getElementById('totalLength');
        const memoDimInput = document.getElementById('memoDim');
        const pitchInput = document.getElementById('pitch');
        const countInput = document.getElementById('count');
        const inputNo = document.getElementById('inputNo');

        const resQuantity = document.getElementById('resQuantity');
        const resQtyRemainder = document.getElementById('resQtyRemainder');
        const resWidth = document.getElementById('resWidth');
        const resWidthAt = document.getElementById('resWidthAt');
        const resWidthRemainder = document.getElementById('resWidthRemainder');
        const resPitchLabel = document.getElementById('resPitchLabel');
        const resCountLabel = document.getElementById('resCountLabel');
        
        const unitQuantity = document.getElementById('unitQuantity');
        const unitQtyRem = document.getElementById('unitQtyRem');
        const unitWidth = document.getElementById('unitWidth');
        const unitWidthRem = document.getElementById('unitWidthRem');

        const historyTableBody = document.getElementById('historyTableBody');
        const totalQtySum = document.getElementById('totalQtySum');
        const totalQtyRemSum = document.getElementById('totalQtyRemSum');
        const totalCountSum = document.getElementById('totalCountSum');
        const totalWidthRemSum = document.getElementById('totalWidthRemSum');
        const confirmModal = document.getElementById('confirmModal');
        const btnSave = document.getElementById('btnSave');
        const saveToast = document.getElementById('saveToast');

        let historyData = [];
        let currentTab = 'calc';
        let touchStartX = 0;
        let touchStartY = 0;

        window.onload = function() {
            const savedHistory = localStorage.getItem('waritsuke_history');
            if (savedHistory) {
                try {
                    historyData = JSON.parse(savedHistory);
                    updateHistoryTable(false);
                } catch(e) { console.error("Failed to load history", e); }
            }

            const savedInputs = localStorage.getItem('waritsuke_inputs');
            if (savedInputs) {
                try {
                    const inputs = JSON.parse(savedInputs);
                    totalLengthInput.value = inputs.totalLength || "";
                    memoDimInput.value = inputs.memoDim || "";
                    pitchInput.value = inputs.pitch || "";
                    countInput.value = inputs.count || "";
                    inputNo.value = inputs.inputNo || "";
                    
                    [totalLengthInput, memoDimInput, pitchInput, countInput, inputNo].forEach(el => {
                        updateUnitDisplay(el);
                        formatInputDisplay(el);
                    });
                    calculate();
                } catch(e) { console.error("Failed to load inputs", e); }
            }
            initSwipeGestures();
        };

        function initSwipeGestures() {
            const container = document.body;
            container.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            container.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                handleGesture(touchStartX, touchEndX, touchStartY, touchEndY);
            }, { passive: true });
        }

        function handleGesture(startX, endX, startY, endY) {
            const threshold = 80;
            const verticalThreshold = 50;
            const diffX = startX - endX;
            const diffY = Math.abs(startY - endY);
            if (diffY > verticalThreshold) return;
            if (document.activeElement.tagName === 'INPUT') return;
            if (diffX > threshold) {
                if (currentTab === 'calc') switchTab('history');
            } else if (diffX < -threshold) {
                if (currentTab === 'history') switchTab('calc');
            }
        }

        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('screen-' + tabName).classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
            if (tabName === 'history') updateHistoryTable(false);
            window.scrollTo(0, 0);
        }

        function saveInputs() {
            const inputs = {
                totalLength: totalLengthInput.value,
                memoDim: memoDimInput.value,
                pitch: pitchInput.value,
                count: countInput.value,
                inputNo: inputNo.value
            };
            localStorage.setItem('waritsuke_inputs', JSON.stringify(inputs));
        }

        function formatNumber(num) {
            if (num === null || isNaN(num)) return "-";
            return Math.round(num).toLocaleString('ja-JP');
        }

        function parseValue(val) {
            if (!val) return NaN;
            const clean = val.toString().replace(/[^-0-9.]/g, '');
            return parseFloat(clean);
        }

        function updateUnitDisplay(input) {
            const unitSpan = document.getElementById('unit-' + input.id);
            if (!unitSpan) return;
            const val = parseValue(input.value);
            unitSpan.innerText = !isNaN(val) ? (input.getAttribute('data-unit') || "") : "";
        }

        function formatInputDisplay(input) {
            if (input.id === 'inputNo') return;
            let num = parseValue(input.value);
            if (isNaN(num)) {
                input.value = "";
                updateUnitDisplay(input);
                return;
            }
            input.value = num.toLocaleString('ja-JP');
            updateUnitDisplay(input);
        }

        function calculate() {
            // 計算基準を「全幅(W)」のみに固定
            const L = parseValue(totalLengthInput.value); 

            const W = parseValue(pitchInput.value);
            const N = parseValue(countInput.value);

            resQuantity.innerText = "-"; resQtyRemainder.innerText = "-";
            resWidth.innerText = "-"; resWidthRemainder.innerText = "-";
            resPitchLabel.innerText = ""; resCountLabel.innerText = "";
            resWidthAt.classList.add('hidden');
            [unitQuantity, unitQtyRem, unitWidth, unitWidthRem].forEach(u => u.classList.add('hidden'));

            if (isNaN(L)) return;

            if (!isNaN(W) && W !== 0) {
                resQuantity.innerText = formatNumber(Math.ceil(L / W));
                resQtyRemainder.innerText = formatNumber(L % W);
                resPitchLabel.innerText = `@${formatNumber(W)}`;
                unitQuantity.classList.remove('hidden');
                unitQtyRem.classList.remove('hidden');
            }
            if (!isNaN(N) && N !== 0) {
                resWidth.innerText = formatNumber(Math.ceil(L / N));
                resWidthRemainder.innerText = formatNumber(L % N);
                resCountLabel.innerText = `${formatNumber(N)}枚入`;
                resWidthAt.classList.remove('hidden');
                unitWidth.classList.remove('hidden');
                unitWidthRem.classList.remove('hidden');
            }
        }

        function updateHistoryTable(shouldSave = true) {
            historyTableBody.innerHTML = '';
            let sumQ = 0, sumQR = 0, sumN = 0, sumWR = 0;
            const separatorColor = "#545458"; 
            
            historyData.slice().reverse().forEach((item, originalIdx) => {
                const idx = historyData.length - 1 - originalIdx;
                const tr = document.createElement('tr');
                tr.className = `border-t border-[${separatorColor}]`;
                
                // 履歴内のL寸法メモの色を元のオレンジ（#ff9f0a）に戻す
                const memoHtml = item.memo ? `<div class="text-[17px] text-[#ff9f0a] font-medium truncate">L:${item.memo}</div>` : '';
                const noBadge = item.no ? `<span class="inline-block bg-[#48484a] text-white text-[14px] px-2 py-0.5 rounded-full mr-1 font-bold">No.${item.no}</span>` : '';
                
                const td1 = document.createElement('td');
                td1.className = `py-1.5 px-1 border-r border-[${separatorColor}] overflow-hidden`;
                if (item.type === 'totalLength') {
                    td1.innerHTML = `
                        <div class="flex flex-col items-center justify-center text-center">
                            <div class="flex items-center justify-center">${noBadge}<span class="text-[16px] text-gray-400 truncate leading-tight">W:${item.input}</span></div>
                            <span class="text-[19px] font-bold text-[#0a84ff]">${item.result}枚</span>
                            <span class="text-[17px] text-gray-400">(@${item.pitch}) 残:${item.rem}</span>
                            ${memoHtml}
                        </div>`;
                    sumQ += item.resultNum; sumQR += item.remNum;
                } else td1.innerHTML = `<span class="text-[#38383a]">-</span>`;
                
                const td2 = document.createElement('td');
                td2.className = `py-1.5 px-1 border-r border-[${separatorColor}] overflow-hidden`;
                if (item.type === 'count') {
                    td2.innerHTML = `
                        <div class="flex flex-col items-center justify-center text-center">
                            <div class="flex items-center justify-center">${noBadge}<span class="text-[16px] text-gray-400 truncate leading-tight">${item.input}枚</span></div>
                            <div class="flex items-baseline justify-center gap-0.5">
                                <span class="text-gray-400 text-[16px]">＠</span>
                                <span class="text-[19px] font-bold text-[#30d158]">${item.result}㎜</span>
                            </div>
                            <span class="text-[17px] text-gray-400">残:${item.rem}</span>
                            ${memoHtml}
                        </div>`;
                    sumN += item.inputNum; sumWR += item.remNum;
                } else td2.innerHTML = `<span class="text-[#38383a]">-</span>`;
                
                const td3 = document.createElement('td');
                td3.className = "py-0";
                td3.innerHTML = `
                    <button onclick="deleteHistoryRow(${idx})" class="p-2 text-red-500 active:text-red-600 w-full flex justify-center items-center">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>`;
                tr.append(td1, td2, td3);
                historyTableBody.appendChild(tr);
            });
            totalQtySum.innerText = sumQ > 0 ? formatNumber(sumQ) + "枚" : "-";
            totalQtyRemSum.innerText = sumQ > 0 ? "残計:" + formatNumber(sumQR) : "-";
            totalCountSum.innerText = sumN > 0 ? formatNumber(sumN) + "枚" : "-";
            totalWidthRemSum.innerText = sumN > 0 ? "残計:" + formatNumber(sumWR) : "-";
            if (shouldSave) { localStorage.setItem('waritsuke_history', JSON.stringify(historyData)); }
        }

        function showSaveToast() {
            saveToast.classList.add('show');
            setTimeout(() => { saveToast.classList.remove('show'); }, 1200);
        }

        function manualSaveToHistory() {
            const L = parseValue(totalLengthInput.value); 
            const W = parseValue(pitchInput.value);
            const N = parseValue(countInput.value);
            const noVal = inputNo.value;
            const memoVal = memoDimInput.value;
            let savedCount = 0;

            if (isNaN(L)) return;

            if (!isNaN(W) && W !== 0) {
                const qty = Math.ceil(L / W);
                const rem = L % W;
                historyData.push({
                    type: 'totalLength', memo: memoVal, no: noVal,
                    input: formatNumber(L), pitch: formatNumber(W),
                    resultNum: qty, result: formatNumber(qty),
                    remNum: rem, rem: formatNumber(rem)
                });
                savedCount++;
            }
            if (!isNaN(N) && N !== 0) {
                const width = Math.ceil(L / N);
                const rem = L % N;
                historyData.push({
                    type: 'count', memo: memoVal, no: noVal,
                    inputNum: N, input: formatNumber(N),
                    resultNum: width, result: formatNumber(width),
                    remNum: rem, rem: formatNumber(rem)
                });
                savedCount++;
            }
            if (savedCount > 0) {
                updateHistoryTable();
                showSaveToast();
            }
        }

        function deleteHistoryRow(index) {
            historyData.splice(index, 1);
            updateHistoryTable();
        }

        function clearSingleField(id) {
            const el = document.getElementById(id);
            el.value = '';
            updateUnitDisplay(el);
            calculate();
            saveInputs();
            el.focus();
        }

        function clearAllFields() {
            [totalLengthInput, memoDimInput, pitchInput, countInput, inputNo].forEach(el => {
                el.value = '';
                updateUnitDisplay(el);
            });
            calculate();
            saveInputs();
        }

        function showConfirmModal() {
            if (historyData.length === 0) return;
            confirmModal.classList.add('show');
        }

        function hideConfirmModal() { confirmModal.classList.remove('show'); }

        function clearHistory() {
            historyData = [];
            localStorage.removeItem('waritsuke_history');
            updateHistoryTable(false);
            hideConfirmModal();
        }

        memoDimInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                pitchInput.focus();
            }
        });

        pitchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                countInput.focus();
            }
        });

        countInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                totalLengthInput.focus();
            }
        });

        totalLengthInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                inputNo.focus();
            }
        });

        inputNo.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                inputNo.blur();
            }
        });

        [totalLengthInput, memoDimInput, pitchInput, countInput, inputNo].forEach(el => {
            el.addEventListener('focus', (e) => {
                if (e.target.id !== 'inputNo') {
                    const val = parseValue(e.target.value);
                    if (!isNaN(val)) e.target.value = val;
                }
                setTimeout(() => { e.target.setSelectionRange(0, e.target.value.length); }, 10);
            });
            el.addEventListener('input', (e) => { 
                if (e.target.id === 'inputNo') { e.target.value = e.target.value.replace(/[^0-9]/g, ''); }
                calculate(); saveInputs();
            });
            el.addEventListener('blur', (e) => {
                formatInputDisplay(e.target);
                saveInputs();
            });
        });
    </script>
</body>
</html>